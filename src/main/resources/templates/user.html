<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard â€“ User Management</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    /* message boxes (same style as admin) */
    .form-error{
      color:#842029;background:#f8d7da;border:1px solid #f5c2c7;border-radius:4px;
      padding:6px 10px;margin-top:8px;font-size:.9rem;
    }
    .form-success{
      color:#0f5132;background:#d1e7dd;border:1px solid #badbcc;border-radius:4px;
      padding:10px 15px;margin-top:12px;font-size:1rem;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .container {
        padding: 0 12px;
      }

      .card {
        margin-bottom: 16px;
      }

      .card-body {
        padding: 16px;
      }

      h2 {
        font-size: 24px;
      }

      .card-title {
        font-size: 20px;
      }

      /* Ensure form inputs are touch-friendly */
      input.form-control {
        padding: 12px;
        font-size: 16px;
        min-height: 44px;
      }

      /* Make buttons touch-friendly */
      .btn {
        padding: 12px 16px;
        font-size: 16px;
        min-height: 44px;
      }

      /* Stack buttons on mobile - target the specific button container */
      .col-12.d-grid.d-sm-flex.justify-content-sm-end {
        display: grid !important;
      }

      .col-12.d-grid.d-sm-flex.justify-content-sm-end .btn {
        width: 100%;
      }

      /* Adjust navbar for mobile */
      .navbar-brand {
        font-size: 18px;
      }

      .navbar .btn {
        font-size: 14px;
        padding: 8px 12px;
        min-height: auto;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 0 8px;
      }

      h2 {
        font-size: 22px;
      }

      .card-body {
        padding: 12px;
      }

      .navbar-brand {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar (matches admin) -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">User Dashboard</a>
      <form class="d-flex">
        <a class="btn btn-outline-light" href="/logout">Logout</a>
      </form>
    </div>
  </nav>

  <div class="container mt-4">
    <h2 th:text="'Welcome, ' + ${username} + '!'">Welcome!</h2>
    <p class="text-muted">Your role: USER</p>

    <div class="row mt-3">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="card-title mb-3">Your Profile</h4>

            <form id="profileForm" class="row g-3">
              <div class="col-12">
                <label class="form-label" for="email">Email</label>
                <input type="email"
                       id="email"
                       class="form-control"
                       th:value="${email}"
                       required />
              </div>
              <div class="col-12">
                <label class="form-label" for="password">New Password</label>
                <input type="password"
                       id="password"
                       class="form-control"
                       placeholder="Leave blank to keep unchanged"/>
              </div>
              <div class="col-12 d-grid d-sm-flex justify-content-sm-end">
                <button type="submit" class="btn btn-primary">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- messages BELOW the main box, same width, not extending the card -->
        <div id="profileSuccess" class="form-success d-none">
          Profile updated successfully.
        </div>
        <div id="profileError" class="form-error d-none">
          Failed to update profile.
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = '';

    async function authFetch(path, opts = {}) {
      opts.credentials = 'include';
      opts.headers = { 'Content-Type': 'application/json' };
      const res = await fetch(API + path, opts);
      let data;
      try { data = await res.json(); } catch { data = {}; }
      if (!res.ok) {
        const errorMsg = data?.error || ('HTTP ' + res.status);
        throw new Error(errorMsg);
      }
      return data;
    }

    function clearMessages() {
      document.getElementById('profileSuccess').classList.add('d-none');
      document.getElementById('profileError').classList.add('d-none');
    }

    document.getElementById('profileForm').onsubmit = async e => {
      e.preventDefault();
      clearMessages();

      const email    = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const payload  = { email };

      if (password) payload.password = password;

      try {
        await authFetch('/users/me', {
          method: 'PUT',
          body: JSON.stringify(payload)
        });

        document.getElementById('password').value = '';
        const successBox = document.getElementById('profileSuccess');
        successBox.textContent = 'Profile updated successfully.';
        successBox.classList.remove('d-none');
      } catch (err) {
        const errorBox = document.getElementById('profileError');
        errorBox.textContent = 'Update failed: ' + (err.message || err);
        errorBox.classList.remove('d-none');
      }
    };
  </script>
</body>
</html>
