<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard â€“ User Management</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    /* message boxes (same style as admin) */
    .form-error{
      color:#842029;background:#f8d7da;border:1px solid #f5c2c7;border-radius:4px;
      padding:6px 10px;margin-top:8px;font-size:.9rem;
    }
    .form-success{
      color:#0f5132;background:#d1e7dd;border:1px solid #badbcc;border-radius:4px;
      padding:10px 15px;margin-top:12px;font-size:1rem;
    }
  </style>
</head>
<body>
  <!-- Navbar (matches admin) -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">User Dashboard</a>
      <form class="d-flex" method="post" th:action="@{/logout}">
        <button type="submit" class="btn btn-outline-light">Logout</button>
      </form>
    </div>
  </nav>

  <div class="container mt-4">
    <h2 th:text="'Welcome, ' + ${username} + '!'">Welcome!</h2>
    <p class="text-muted">Your role: USER</p>

    <div class="row mt-3">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="card-title mb-3">Your Profile</h4>

            <form id="profileForm" class="row g-3">
              <div class="col-12">
                <label class="form-label" for="email">Email</label>
                <input type="email"
                       id="email"
                       class="form-control"
                       th:value="${email}"
                       required />
              </div>
              <div class="col-12">
                <label class="form-label" for="password">New Password</label>
                <input type="password"
                       id="password"
                       class="form-control"
                       placeholder="Leave blank to keep unchanged"/>
                <div id="passwordError" class="form-error d-none"></div>
              </div>
              <div class="col-12 d-grid d-sm-flex justify-content-sm-end">
                <button type="submit" class="btn btn-primary">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- messages BELOW the main box, same width, not extending the card -->
        <div id="profileSuccess" class="form-success d-none">
          Profile updated successfully.
        </div>
        <div id="profileError" class="form-error d-none">
          Failed to update profile.
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = '';

    async function authFetch(path, opts = {}) {
      opts.credentials = 'include';
      opts.headers = { 'Content-Type': 'application/json' };
      const res = await fetch(API + path, opts);
      let data;
      try { data = await res.json(); } catch { data = {}; }
      if (!res.ok) {
        const errorMsg = data?.error || ('HTTP ' + res.status);
        throw new Error(errorMsg);
      }
      return data;
    }

    /**
     * Validates password against backend rules (ValidationPatterns.java)
     * @param {string} password - The password to validate
     * @returns {object} - { valid: boolean, message: string }
     */
    function validatePassword(password) {
      // Backend requirements from ValidationPatterns.PASSWORD_PATTERN:
      // - At least 8 characters
      // - At least one lowercase letter
      // - At least one uppercase letter
      // - At least one digit
      // - At least one special character

      if (password.length < 8) {
        return {
          valid: false,
          message: 'Password must be at least 8 characters long.'
        };
      }

      if (!/[a-z]/.test(password)) {
        return {
          valid: false,
          message: 'Password must contain at least one lowercase letter.'
        };
      }

      if (!/[A-Z]/.test(password)) {
        return {
          valid: false,
          message: 'Password must contain at least one uppercase letter.'
        };
      }

      if (!/\d/.test(password)) {
        return {
          valid: false,
          message: 'Password must contain at least one digit.'
        };
      }

      if (!/[@$!%*?&#^()_+\-=\[\]{};':"\\|,.<>/~`]/.test(password)) {
        return {
          valid: false,
          message: 'Password must contain at least one special character (!@#$%^&* etc.).'
        };
      }

      return { valid: true, message: '' };
    }

    function clearMessages() {
      document.getElementById('profileSuccess').classList.add('d-none');
      document.getElementById('profileError').classList.add('d-none');
      document.getElementById('passwordError').classList.add('d-none');
    }

    document.getElementById('profileForm').onsubmit = async e => {
      e.preventDefault();
      clearMessages();

      const email    = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const passwordError = document.getElementById('passwordError');
      const payload  = { email };

      // Validate password if provided (optional for profile update)
      if (password) {
        const passwordValidation = validatePassword(password);
        if (!passwordValidation.valid) {
          passwordError.textContent = passwordValidation.message;
          passwordError.classList.remove('d-none');
          return;
        }
        payload.password = password;
      }

      try {
        await authFetch('/users/me', {
          method: 'PUT',
          body: JSON.stringify(payload)
        });

        document.getElementById('password').value = '';
        const successBox = document.getElementById('profileSuccess');
        successBox.textContent = 'Profile updated successfully.';
        successBox.classList.remove('d-none');
      } catch (err) {
        const errorBox = document.getElementById('profileError');
        const msg = (err.message || '').toLowerCase();
        
        // Check if it's a password-related error
        if (msg.includes('password')) {
          const passwordError = document.getElementById('passwordError');
          passwordError.textContent = err.message;
          passwordError.classList.remove('d-none');
        } else {
          errorBox.textContent = 'Update failed: ' + (err.message || err);
          errorBox.classList.remove('d-none');
        }
      }
    };
  </script>
</body>
</html>
