<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard – User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    /* message boxes */
    .form-error{
      color:#842029;background:#f8d7da;border:1px solid #f5c2c7;border-radius:4px;
      padding:6px 10px;margin-top:4px;font-size:.9rem;
    }
    .form-success{
      color:#0f5132;background:#d1e7dd;border:1px solid #badbcc;border-radius:4px;
      padding:10px 15px;margin-top:20px;font-size:1rem;
    }

    /* compact create/update button */
    .btn-tight{width:100%;height:38px;}

    /* scrollable users table wrapper (fixed height so form stays put) */
    .users-scroll{
      height:420px;
      overflow-y:auto;
      border:1px solid rgba(0,0,0,.075);
      border-radius:.5rem;
    }
    /* sticky header inside scroll */
    .users-scroll thead th{
      position:sticky; top:0; z-index:2; background:#f8f9fa;
    }

    /* keep layout stable where messages appear */
    .msg-reserve{min-height:44px;} /* ~ one error/success box height */

    /* tighter table rows */
    .table td, .table th { padding:.55rem .75rem; }

    /* highlight the row being edited (no shape change, just tint) */
    .editing-row{
      background:#cfe2ff;
      transition:background .15s ease;
    }
    .editing-row .cell-like{
      background-color:#e7f1ff;
      border-color:#9ec5fe;
    }

    /* cells look a bit like inputs but are read-only */
    .cell-like{
      background-color:#fff;
      border:1px solid #dee2e6;
      border-radius:.25rem;
      padding:.25rem .5rem;
      font-size:.9rem;
    }

    /* AI Summary section styling */
    .stat-card {
      padding: 1rem;
      background: #f8f9fa;
      border-radius: .5rem;
      height: 100%;
    }
    .stat-card h3 {
      color: #0d6efd;
      margin: 0;
      font-size: 2rem;
    }
    #summaryText {
      font-size: 0.95rem;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Admin Dashboard</a>
      <form class="d-flex" method="post" th:action="@{/logout}">
        <button type="submit" class="btn btn-outline-light">Logout</button>
      </form>
    </div>
  </nav>

  <div class="container mt-4">
    <h2>All Users</h2>

    <!-- SCROLLABLE TABLE (fixed height so form below doesn't jump) -->
    <div class="users-scroll shadow-sm">
      <table class="table table-hover mb-0">
        <thead class="table-light">
        <tr>
          <th style="width:70px">ID</th>
          <th style="width:220px">Username</th>
          <th>Email</th>
          <th style="width:130px">Role</th>
          <th style="width:140px">Actions</th>
        </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </div>

    <hr/>
    <!-- this title will change between Create / Edit -->
    <h3 id="formTitle">Create New User</h3>

    <!-- CREATE / UPDATE FORM (ONLY place where editing happens) -->
    <form id="createForm" class="row g-3">
      <div class="col-md-3">
        <input type="text" id="newUsername" class="form-control" placeholder="Username" required/>
        <div id="usernameError" class="form-error d-none"></div>
      </div>
      <div class="col-md-3">
        <input type="email" id="newEmail" class="form-control" placeholder="Email" required/>
        <div id="emailError" class="form-error d-none"></div>
      </div>
      <div class="col-md-3">
        <input type="password" id="newPassword" class="form-control" placeholder="Password"/>
        <div id="passwordError" class="form-error d-none"></div>
      </div>
      <div class="col-md-1">
        <select id="newRole" class="form-select">
          <option value="USER">USER</option>
          <option value="ADMIN">ADMIN</option>
        </select>
      </div>
      <div class="col-md-2 d-grid">
        <button id="createBtn" type="submit" class="btn btn-success btn-tight">Create</button>
      </div>
    </form>

    <!-- reserved gap to avoid layout jump + success box uses same slot -->
    <div class="msg-reserve">
      <div id="createSuccess" class="form-success d-none">User created successfully.</div>
    </div>

    <hr/>
    <!-- AI SUMMARY SECTION -->
    <h3>AI Log Summary</h3>
    <p class="text-muted">Generate AI-powered insights from system logs based on selected filters.</p>
    
    <form id="summaryForm" class="row g-3">
      <div class="col-md-3">
        <label for="summaryStartTime" class="form-label">Start Time</label>
        <input type="datetime-local" id="summaryStartTime" class="form-control" />
      </div>
      <div class="col-md-3">
        <label for="summaryEndTime" class="form-label">End Time</label>
        <input type="datetime-local" id="summaryEndTime" class="form-control" />
      </div>
      <div class="col-md-2">
        <label for="summaryLogLevel" class="form-label">Log Level</label>
        <select id="summaryLogLevel" class="form-select">
          <option value="">All Levels</option>
          <option value="INFO">INFO</option>
          <option value="WARN">WARN</option>
          <option value="ERROR">ERROR</option>
          <option value="DEBUG">DEBUG</option>
        </select>
      </div>
      <div class="col-md-2">
        <label for="summaryActionType" class="form-label">Action Type</label>
        <select id="summaryActionType" class="form-select">
          <option value="">All Actions</option>
          <option value="USER_LOGIN">User Login</option>
          <option value="USER_REGISTRATION">User Registration</option>
          <option value="USER_CREATE">User Create</option>
          <option value="USER_UPDATE">User Update</option>
          <option value="USER_DELETE">User Delete</option>
          <option value="EMAIL_VERIFICATION">Email Verification</option>
          <option value="PASSWORD_RESET">Password Reset</option>
          <option value="LOG_SUMMARIZATION">Log Summarization</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button id="generateSummaryBtn" type="submit" class="btn btn-primary w-100">Generate Summary</button>
      </div>
    </form>

    <!-- Summary Results -->
    <div id="summaryResults" class="mt-4 d-none">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Summary Results</h5>
        </div>
        <div class="card-body">
          <!-- Summary Stats -->
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="stat-card">
                <h6 class="text-muted">Total Logs</h6>
                <h3 id="totalLogs">0</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <h6 class="text-muted">Time Range</h6>
                <p id="timeRange" class="mb-0 small">-</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="stat-card">
                <h6 class="text-muted">Log Levels</h6>
                <div id="logLevels" class="small">-</div>
              </div>
            </div>
          </div>

          <!-- AI Summary Text -->
          <div class="alert alert-info">
            <h6 class="alert-heading">AI Analysis</h6>
            <div id="summaryText">Loading...</div>
          </div>

          <!-- Action Types Distribution -->
          <div id="actionTypesSection" class="mt-3">
            <h6>Action Types Distribution</h6>
            <div id="actionTypes" class="small"></div>
          </div>

          <!-- Top Issues -->
          <div id="topIssuesSection" class="mt-3">
            <h6>Top Issues</h6>
            <ul id="topIssues"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading spinner -->
    <div id="summaryLoading" class="text-center mt-4 d-none">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Generating AI summary...</p>
    </div>

    <!-- Error message -->
    <div id="summaryError" class="alert alert-danger mt-4 d-none" role="alert"></div>

    <hr/>
    <!-- SYSTEM HEALTH SECTION -->
    <h3>System Health</h3>
    <p class="text-muted">Real-time system health metrics including application status and database connectivity.</p>
    
    <!-- Health Results -->
    <div id="healthResults" class="mt-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">System Health Status</h5>
        </div>
        <div class="card-body">
          <!-- Health Stats -->
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="stat-card">
                <h6 class="text-muted">Application Status</h6>
                <h3 id="appStatus" class="text-success">Loading...</h3>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-card">
                <h6 class="text-muted">Database Status</h6>
                <h3 id="dbStatus" class="text-muted">Loading...</h3>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-card">
                <h6 class="text-muted">Last Updated</h6>
                <p id="healthLastUpdated" class="mb-0 small">-</p>
              </div>
            </div>
          </div>

          <!-- Health Details -->
          <div id="healthDetails" class="alert alert-secondary">
            <h6 class="alert-heading">Health Details</h6>
            <div id="healthDetailsText">Loading health data...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Health Error message -->
    <div id="healthError" class="alert alert-danger mt-4 d-none" role="alert"></div>
  </div>

  <script>
    const API = '';
    let editingUserId   = null;   // when set, the Create button acts as Update
    let editingUserName = null;   // for heading text

    async function authFetch(path, opts = {}) {
      opts.credentials = 'include';
      opts.headers = { 'Content-Type': 'application/json' };
      const res = await fetch(API + path, opts);
      let data;
      try { data = await res.json(); } catch { data = {}; }
      if (!res.ok) {
        const errorMsg = data?.error || 'HTTP ' + res.status;
        throw new Error(errorMsg);
      }
      return data;
    }

    function clearMessages() {
      document.getElementById('usernameError').classList.add('d-none');
      document.getElementById('emailError').classList.add('d-none');
      document.getElementById('passwordError').classList.add('d-none');
      document.getElementById('createSuccess').classList.add('d-none');
    }

    function clearRowHighlight(){
      document
        .querySelectorAll('#usersTableBody tr.editing-row')
        .forEach(r => r.classList.remove('editing-row'));
    }

    function highlightRow(id){
      clearRowHighlight();
      const row = document.querySelector(`#usersTableBody tr[data-row-id="${id}"]`);
      if(row) row.classList.add('editing-row');
    }

    function setFormMode(mode){ // 'create' | 'update'
      const btn        = document.getElementById('createBtn');
      const title      = document.getElementById('formTitle');
      const passwordEl = document.getElementById('newPassword');

      if(mode==='update'){
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
        btn.textContent = 'Save Update';
        if (title){
          const label = editingUserName || editingUserId || '';
          title.textContent = label ? `Edit User (${label})` : 'Edit User';
        }
        if (passwordEl){
          passwordEl.placeholder = 'Leave blank to keep password';
        }
      }else{
        editingUserId   = null;
        editingUserName = null;
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        btn.textContent = 'Create';
        document.getElementById('createForm').reset();
        clearRowHighlight();
        if (title) title.textContent = 'Create New User';
        if (passwordEl){
          passwordEl.placeholder = 'Password';
        }
      }
      clearMessages();
    }

    async function loadUsers() {
      try {
        const users = await authFetch('/users', { method: 'GET' });
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        users.forEach(u => {
          const tr = document.createElement('tr');
          tr.dataset.rowId = u.id;
          if (editingUserId && u.id === editingUserId) tr.classList.add('editing-row');

          tr.innerHTML = `
            <td>${u.id}</td>
            <td class="user-username cell-like" data-id="${u.id}">${u.username}</td>
            <td class="user-email cell-like" data-id="${u.id}">${u.email}</td>
            <td class="user-role cell-like" data-id="${u.id}">${u.role}</td>
            <td class="d-flex gap-2">
              <button class="btn btn-sm btn-primary edit-in-form" data-id="${u.id}">Edit</button>
              <button class="btn btn-sm btn-danger delete-btn" data-id="${u.id}">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });

        attachHandlers(users);
      } catch (e) {
        alert('Error loading users: ' + e);
      }
    }

    function attachHandlers(cachedUsers) {
      // Edit → copy row values into the bottom form and highlight row
      document.querySelectorAll('.edit-in-form').forEach(btn => {
        btn.onclick = () => {
          const id = +btn.dataset.id;
          const u = cachedUsers.find(x => x.id === id);
          if (!u) return;

          // copy values to form (ONLY editable place)
          document.getElementById('newUsername').value = u.username;
          document.getElementById('newEmail').value    = u.email;
          document.getElementById('newRole').value     = u.role;
          document.getElementById('newPassword').value = '';

          editingUserId   = id;
          editingUserName = u.username;
          setFormMode('update');
          highlightRow(id);

          // bring form into view
          document.getElementById('createForm')
                  .scrollIntoView({behavior:'smooth', block:'center'});
        };
      });

      // Delete
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Delete this user?')) return;
          try {
            const id = +btn.dataset.id;
            await authFetch(`/users/${id}`, { method: 'DELETE' });
            if (editingUserId === id) setFormMode('create');
            loadUsers();
          } catch (err) {
            alert('❌ Delete failed: ' + err.message);
          }
        };
      });
    }

    /**
     * Validates password against backend rules (ValidationPatterns.java)
     * @param {string} password - The password to validate
     * @returns {object} - { valid: boolean, message: string }
     */
    function validatePassword(password) {
      // Backend requirements from ValidationPatterns.PASSWORD_PATTERN:
      // - At least 8 characters
      // - At least one lowercase letter
      // - At least one uppercase letter
      // - At least one digit
      // - At least one special character

      if (password.length < 8) {
        return {
          valid: false,
          message: 'Password must be at least 8 characters long.'
        };
      }

      if (!/[a-z]/.test(password)) {
        return {
          valid: false,
          message: 'Password must contain at least one lowercase letter.'
        };
      }

      if (!/[A-Z]/.test(password)) {
        return {
          valid: false,
          message: 'Password must contain at least one uppercase letter.'
        };
      }

      if (!/\d/.test(password)) {
        return {
          valid: false,
          message: 'Password must contain at least one digit.'
        };
      }

      if (!/[@$!%*?&#^()_+\-=\[\]{};':"\\|,.<>/~`]/.test(password)) {
        return {
          valid: false,
          message: 'Password must contain at least one special character (!@#$%^&* etc.).'
        };
      }

      return { valid: true, message: '' };
    }

    // Create / Update submit
    document.getElementById('createForm').onsubmit = async (e) => {
      e.preventDefault();
      clearMessages();

      const usernameField = document.getElementById('newUsername');
      const emailField    = document.getElementById('newEmail');
      const passwordField = document.getElementById('newPassword');
      const roleField     = document.getElementById('newRole');
      const usernameError = document.getElementById('usernameError');
      const emailError    = document.getElementById('emailError');
      const passwordError = document.getElementById('passwordError');
      const successBox    = document.getElementById('createSuccess');

      const username = usernameField.value.trim();
      const email    = emailField.value.trim();
      const role     = roleField.value;
      const password = passwordField.value;

      // Validate password if provided (required for create, optional for update)
      if (password) {
        const passwordValidation = validatePassword(password);
        if (!passwordValidation.valid) {
          passwordError.textContent = passwordValidation.message;
          passwordError.classList.remove('d-none');
          return;
        }
      } else if (!editingUserId) {
        // Password is required when creating a new user
        passwordError.textContent = 'Password is required when creating a new user.';
        passwordError.classList.remove('d-none');
        return;
      }

      try {
        const users = await authFetch('/users', { method: 'GET' });
        const lowerU = username.toLowerCase(), lowerE = email.toLowerCase();

        // exclude record being edited from duplicate checks
        const usernameTaken = users.some(u =>
          (editingUserId ? u.id !== editingUserId : true) &&
          (u.username||'').toLowerCase() === lowerU
        );
        const emailTaken = users.some(u =>
          (editingUserId ? u.id !== editingUserId : true) &&
          (u.email||'').toLowerCase() === lowerE
        );

        let blocked = false;
        if (usernameTaken){
          usernameError.textContent = 'Username already exists.';
          usernameError.classList.remove('d-none');
          blocked = true;
        }
        if (emailTaken){
          emailError.textContent = 'Email already in use.';
          emailError.classList.remove('d-none');
          blocked = true;
        }
        if (blocked) return;

        if (editingUserId){ // update existing user
          const payload = { username, email, role };
          if (password) payload.password = password;
          await authFetch(`/users/${editingUserId}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
          });
          successBox.textContent = 'User updated successfully.';
          successBox.classList.remove('d-none');
          setFormMode('create');
        }else{ // create new user
          await authFetch('/users', {
            method: 'POST',
            body: JSON.stringify({ username, email, password, role })
          });
          successBox.textContent = 'User created successfully.';
          successBox.classList.remove('d-none');
          e.target.reset();
        }

        loadUsers();
      } catch (err) {
        const msg = (err.message || '').toLowerCase();
        let shown = false;
        if (msg.includes('username')) {
          usernameError.textContent = 'Username already exists.';
          usernameError.classList.remove('d-none');
          shown = true;
        }
        if (msg.includes('email')) {
          emailError.textContent = 'Email already in use.';
          emailError.classList.remove('d-none');
          shown = true;
        }
        if (msg.includes('password')) {
          passwordError.textContent = err.message;
          passwordError.classList.remove('d-none');
          shown = true;
        }
        if (!shown) {
          // Show generic error in the email field (general error location)
          emailError.textContent = editingUserId
            ? 'Failed to update user.'
            : 'Failed to create user.';
          emailError.classList.remove('d-none');
        }
      }
    };

    // Initial load
    loadUsers();
    
    // System Health functionality
    async function loadHealthData() {
      try {
        // Fetch health data from actuator endpoint
        const response = await fetch('/actuator/health', {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch health data');
        }
        
        const healthData = await response.json();
        
        // Update overall application status
        const appStatusEl = document.getElementById('appStatus');
        const status = healthData.status || 'UNKNOWN';
        appStatusEl.textContent = status;
        
        // Set color based on status
        appStatusEl.classList.remove('text-success', 'text-danger', 'text-warning', 'text-muted');
        if (status === 'UP') {
          appStatusEl.classList.add('text-success');
        } else if (status === 'DOWN') {
          appStatusEl.classList.add('text-danger');
        } else if (status === 'OUT_OF_SERVICE') {
          appStatusEl.classList.add('text-warning');
        } else {
          appStatusEl.classList.add('text-muted');
        }
        
        // Update database status
        const dbStatusEl = document.getElementById('dbStatus');
        let dbStatus = 'UNKNOWN';
        let dbStatusClass = 'text-muted';
        
        if (healthData.components && healthData.components.db) {
          dbStatus = healthData.components.db.status || 'UNKNOWN';
          if (dbStatus === 'UP') {
            dbStatusClass = 'text-success';
          } else if (dbStatus === 'DOWN') {
            dbStatusClass = 'text-danger';
          } else if (dbStatus === 'OUT_OF_SERVICE') {
            dbStatusClass = 'text-warning';
          }
        }
        
        dbStatusEl.textContent = dbStatus;
        dbStatusEl.classList.remove('text-success', 'text-danger', 'text-warning', 'text-muted');
        dbStatusEl.classList.add(dbStatusClass);
        
        // Update last updated timestamp
        const now = new Date();
        document.getElementById('healthLastUpdated').textContent = now.toLocaleString();
        
        // Update health details
        const healthDetailsEl = document.getElementById('healthDetailsText');
        let detailsHtml = '<div class="small">';
        
        if (healthData.components) {
          detailsHtml += '<strong>Components:</strong><br>';
          Object.entries(healthData.components).forEach(([key, component]) => {
            const componentStatus = component.status || 'UNKNOWN';
            let badgeClass = 'bg-secondary';
            if (componentStatus === 'UP') {
              badgeClass = 'bg-success';
            } else if (componentStatus === 'DOWN') {
              badgeClass = 'bg-danger';
            } else if (componentStatus === 'OUT_OF_SERVICE') {
              badgeClass = 'bg-warning';
            }
            
            detailsHtml += `<span class="badge ${badgeClass} me-2 mb-1">${key}: ${componentStatus}</span>`;
            
            // Show database details if available
            if (key === 'db' && component.details) {
              detailsHtml += '<br><span class="text-muted ms-2">Database: ' + 
                            (component.details.database || 'Unknown') + '</span>';
            }
          });
        } else {
          detailsHtml += '<span class="text-muted">No detailed component information available</span>';
        }
        
        detailsHtml += '</div>';
        healthDetailsEl.innerHTML = detailsHtml;
        
        // Hide error message
        document.getElementById('healthError').classList.add('d-none');
        
      } catch (err) {
        console.error('Error loading health data:', err);
        
        // Show error message
        const errorEl = document.getElementById('healthError');
        errorEl.textContent = 'Error loading health data: ' + (err.message || 'Unknown error');
        errorEl.classList.remove('d-none');
        
        // Update status to show error
        document.getElementById('appStatus').textContent = 'ERROR';
        document.getElementById('appStatus').classList.add('text-danger');
        document.getElementById('dbStatus').textContent = 'ERROR';
        document.getElementById('dbStatus').classList.add('text-danger');
      }
    }
    
    // Load health data on page load
    loadHealthData();
    
    // Refresh health data every 30 seconds
    setInterval(loadHealthData, 30000);

    // AI Summary functionality
    document.getElementById('summaryForm').onsubmit = async (e) => {
      e.preventDefault();
      
      const startTimeInput = document.getElementById('summaryStartTime').value;
      const endTimeInput = document.getElementById('summaryEndTime').value;
      const logLevel = document.getElementById('summaryLogLevel').value;
      const actionType = document.getElementById('summaryActionType').value;
      
      // Convert local datetime to ISO8601 UTC format
      const startTime = startTimeInput ? new Date(startTimeInput).toISOString() : null;
      const endTime = endTimeInput ? new Date(endTimeInput).toISOString() : null;
      
      // Build query parameters
      const params = new URLSearchParams();
      if (startTime) params.append('startTime', startTime);
      if (endTime) params.append('endTime', endTime);
      if (logLevel) params.append('logLevel', logLevel);
      if (actionType) params.append('actionType', actionType);
      
      // Show loading state
      document.getElementById('summaryLoading').classList.remove('d-none');
      document.getElementById('summaryResults').classList.add('d-none');
      document.getElementById('summaryError').classList.add('d-none');
      
      try {
        const response = await authFetch(`/api/v1/logs/summarize?${params}`, { method: 'GET' });
        
        // Update stats
        document.getElementById('totalLogs').textContent = response.totalLogs || 0;
        
        // Format time range
        const formatTime = (isoStr) => {
          if (!isoStr) return 'Not specified';
          const date = new Date(isoStr);
          return date.toLocaleString();
        };
        const timeRangeText = `${formatTime(response.startTime)} - ${formatTime(response.endTime)}`;
        document.getElementById('timeRange').textContent = timeRangeText;
        
        // Display log levels
        const logLevelsEl = document.getElementById('logLevels');
        if (response.logLevelStats && Object.keys(response.logLevelStats).length > 0) {
          logLevelsEl.innerHTML = ''; // Clear previous content
          Object.entries(response.logLevelStats).forEach(([level, count]) => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-secondary me-1';
            badge.textContent = `${level}: ${count}`;
            logLevelsEl.appendChild(badge);
          });
        } else {
          logLevelsEl.textContent = 'No data';
        }
        
        // Display summary text
        document.getElementById('summaryText').textContent = response.summary || 'No summary available.';
        
        // Display action types
        const actionTypesEl = document.getElementById('actionTypes');
        const actionTypesSection = document.getElementById('actionTypesSection');
        if (response.actionTypeStats && Object.keys(response.actionTypeStats).length > 0) {
          actionTypesEl.innerHTML = ''; // Clear previous content
          Object.entries(response.actionTypeStats).forEach(([action, count]) => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-info me-1';
            badge.textContent = `${action}: ${count}`;
            actionTypesEl.appendChild(badge);
          });
          actionTypesSection.classList.remove('d-none');
        } else {
          actionTypesSection.classList.add('d-none');
        }
        
        // Display top issues
        const topIssuesEl = document.getElementById('topIssues');
        const topIssuesSection = document.getElementById('topIssuesSection');
        if (response.topIssues && response.topIssues.length > 0) {
          topIssuesEl.innerHTML = ''; // Clear previous content
          response.topIssues.forEach(issue => {
            const li = document.createElement('li');
            li.textContent = issue;
            topIssuesEl.appendChild(li);
          });
          topIssuesSection.classList.remove('d-none');
        } else {
          topIssuesSection.classList.add('d-none');
        }
        
        // Show results
        document.getElementById('summaryResults').classList.remove('d-none');
        
        // Scroll to results
        document.getElementById('summaryResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
        
      } catch (err) {
        const errorEl = document.getElementById('summaryError');
        errorEl.textContent = 'Error generating summary: ' + (err.message || 'Unknown error');
        errorEl.classList.remove('d-none');
      } finally {
        document.getElementById('summaryLoading').classList.add('d-none');
      }
    };
  </script>
</body>
</html>
